<!DOCTYPE html>
<html>
<head>
  <title>Draw a picture following flow fields</title>

  <style>
  body {
    background-color: #000;
    margin: 0 auto;
    overflow: auto;
    font-size: 14px;
    font-family: Open Sans, Segoe Ui, "Open Sans", sans-serif;
    color: #FFF
  }

  canvas{
    margin: 0 auto;
    width: 500px;
    height: 500px;
  }

  #particles{
    margin: 0 auto;
    width: 500px;
    height: 500px;
  }

  button{
    padding: 5px 15px;
    background: none;
    border: 1px solid #AAA;
    color: #AAA;
    margin: 5px;
  }

  span{
    color: #AAA;
  }

  a{
    color:#5393DF;
  }

  button:hover{
    background: #222;
  }

  div.container{
    width: 1000px;
    margin: 20px auto;
  }

  div.container div{
    width: 500px;
    float: left;
  }

  h1{
    font-weight: normal;
  }

  </style>
</head>

<body>

<div class="container">

  <div>
    <canvas id="originalImage"></canvas>
    <button id="new">Click to start another one</button>
    <button id="save">Save image</button>
    <button id="clean">Clean</button>
  </div>

  <div>
    <canvas id="particles"></canvas>
    <span> Original image by <a id="author" href = "#" target="_blank"> </a> </br>
    <span> Noise seed: <san id="seed"></span> </span> </br>
    <span> Noise delta: <san id="delta"></span> </span> </br>
  </div>

  <h1>Painting with particles</h1>
  <p>Particles move following a flow field. When they are born they take the color of the picture at that x,y position then drag that color while they are alive.
    <br/><br/>
    The flow field works by generating a 2D perlin noise map, then we shift the particle's x axis velocity depending on the value given by the map at that x,y position. Every particle has an age and when they die they are reborn in their last position but taking a new color. When a particle reaches the top of the canvas we make it reappear at a random position.
</div>

<script src='../js/perlin.js'></script>
<script src='../js/jquery-2.1.3.min.js'></script>
<script src="../js/fileSaver.js"></script>
<script src="../js/ga.js"></script>
<script>

var images = [
  ["d.jpg",  "Dum Machine Music Video", "https://www.youtube.com/watch?v=-5DYDyPvk28"],
  ["gera/11.jpg", "Alex wong", "https://unsplash.com/photos/l5Tzv1alcps"],
  ["gera/22.jpg", "vadim kaipov", "https://unsplash.com/photos/WsHdnUs6i28"],
  ["gera/33.jpg", "Michael Fertig", "https://unsplash.com/photos/KZ1-ncOXdns"],
  ["gera/44.jpg", "Hoach Le Dinh", "https://unsplash.com/photos/c8TWWQ5ZnUw"],
  ["gera/55.jpg", "Sylvain Reygaerts", "https://unsplash.com/photos/kxxL-EhOlBU"],
  ["p6.jpg", "Llywelyn Nys", "https://unsplash.com/photos/pXfewQhyVeU"],
  ["gera/nasa.jpg", "NASA", "https://unsplash.com/photos/rTZW4f02zY8"],
  ["p7.jpg", "Frank Marino", "https://unsplash.com/photos/DiCfM619cRM"],
  ["girl.jpg", "Larisa Birta", "https://unsplash.com/photos/3XARXIgsoqY"],
  ["p8.jpg", "Frank Marino", "https://unsplash.com/photos/7SokKNHZu54"]
];

var index = 0;
var imgsrc = images[index][0];

var Particle = function(){
  this.x = 0;
  this.y = 0;
  this.vy = 0;
  this.age=0;
  this.moveHorizontal = true;
  
  this.init = function(){
    this.maxLifeTime = Math.floor(5+Math.random()*5);
    this.y = canvas2.height * Math.random();
    this.x = Math.random()*canvas2.height;
    
    this.color= "rgba(0,0,0,255)";
    this.moveHorizontal = true;//Math.random() > 0.5 ? true : false;
    if(this.moveHorizontal){
      this.vy = 2;
    this.vx = 5;
  }else{
    this.vy = 5;
    this.vx = 2;
  }
    //this.needsColorSet = true;
  }

  this.update = function(value){
    //console.log(value);
    this.age += 0.1;
    if(this.moveHorizontal){
      this.y -= this.vy;
      this.x += value*this.vx;// + wind;
    }else{
      this.y -= value*this.vy;
      this.x += this.vx;// + wind;
    }
    
    if(this.x < 0){
      this.x = canvas2.height;
      //this.init();
    }else if(this.x > canvas2.height){
      this.x = 0;
      //this.init();
    }

    // if(this.needsColorSet){
    //   this.needsColorSet = false;
    //   this.setColor();
    // }

    if(this.y < 0){
      //this.y = Math.random()*canvas2.height;
       //this.x = Math.random()*canvas2.height;
      this.init();
    }else if(this.y > canvas2.height)
    {
      //this.y = 0;
      this.init();
    }

    if(this.age >= this.maxLifeTime){
      this.age = 0;
      this.setColor();
    }
  }

  this.setColor = function(){
    if(!imageReady) return;
   // console.log(this.x, this.y);
    //var pixelData = ctx.getImageData(Math.floor(this.x/4), Math.floor(this.y/4), 1, 1).data;
    //var pixelData = [255,200,100];//ctx.getImageData(Math.floor(this.x), Math.floor(this.y), 1, 1).data;
    var pData = (Math.floor(this.x) + (Math.floor(this.y) * canvas.width)) * 4;

      var r = pixelData[pData];
      var g = pixelData[pData+1];
      var b = pixelData[pData+2];
      this.color = "rgba("+r+", "+g+", "+b+",255)";
  }

  this.init();
  this.setColor();
}


$('#new').click(function(){

  index = ++index%images.length;
  imgsrc = images[index][0];

  doit(imgsrc);
} );


$('#clean').click(function(){
  ctx2.clearRect(0,0, canvas.width, canvas.height);
} );

//Obtener dos canvas (Uno va a tener la imagen original y el otro es donde vamos a pintar las particulas)
var canvas = document.getElementById('originalImage');  
var ctx = canvas.getContext('2d');
var canvas2 = document.getElementById('particles');
var ctx2 = canvas2.getContext('2d');
var particles = [];
var numParticles = 2000;
var delta = 140;
var wind = 0;
var imageReady = false;

var pixelData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

canvas2.width = canvas2.height = 2000;

canvas.width = canvas.height = 2000;

function doit(imgsrc){
  
  imageReady = false;
  var img = new Image();   // Create new img element
  img.addEventListener("load", function() {

    ctx.clearRect(0,0, canvas.width, canvas.height);
    ctx2.fillStyle = "#000";
    ctx2.fillRect(0,0, canvas2.width, canvas2.height);
    ctx.drawImage(img,0,0);
    imageReady = true;
    pixelData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

  }, false);
  
  img.src = imgsrc;

  restart();
  requestAnimationFrame(drawFrame);

};

function drawFrame() {
  
  for(var i=0; i<numParticles; i++){
    var particle = particles[i];
    var value = noise.perlin2(particle.x/delta ,particle.y/delta);
    ctx2.fillStyle = particle.color; 
    ctx2.fillRect(particle.x,particle.y, 1, 1);
    particle.update(value);
  }

  requestAnimationFrame(drawFrame);
}

function restart(){
  //Give a new seed to the noise function, to get a different pattern
  var seed = Math.random();
  noise.seed(seed);
  self.particles = [];
  delta = 200 + Math.random() * 200;
  for(var i=0; i<numParticles; i++){
    self.particles.push(new Particle());
  }

  $("#delta").html(delta);
  $("#seed").html(seed);
  $("#author").html(images[index][1]);
  $("#author").attr("href",images[index][2]);
  
}

doit(imgsrc);

var num=0;

$('#save').click(function(){
  num++;

  if(canvas2.toBlob == undefined){
    link.href = canvas.toDataURL();
    link.download = "Big_ffp"+num+".png";
  }else{
    canvas2.toBlob(function(blob) {
      saveAs(blob, "Big_ffp"+num+".png");
    });
  }

});


</script>
</body>