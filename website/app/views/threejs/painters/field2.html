<!DOCTYPE html>
<html>
<head>
  <title>Flow fields with perlin noise</title>

  <style>
  body {
    background-color: #000;
    margin: 0 auto;
    overflow: auto;
    font-size: 14px;
    font-family: sans-serif;
    color: #FFF
  }

  canvas{
    margin: 0 auto;
    width: 500px;
    height: 500px;
  }

  button{
    padding: 5px 15px;
    background: none;
    border: 1px solid #AAA;
    color: #AAA;
    margin: 5px;
  }

  span{
    color: #AAA;
  }

  a{
    color:#5393DF;
  }

  button:hover{
    background: #222;
  }

  div.container{
    width: 1000px;
    margin: 20px auto;
  }

  div.container div{
    width: 500px;
    float: left;
  }

  </style>
</head>

<body>

<div class="container">

  <div>
    <canvas id="originalImage"></canvas>
    <button id="new">Click to start another one</button>
    <button id="save">Save image</button>
  </div>

  <div>
    <canvas id="particles"></canvas>
    <span> Original image by <a id="author" href = "#" target="_blank"> </a> </br>
    <span> Noise seed: <san id="seed"></span> </span> </br>
    <span> Noise delta: <san id="delta"></span> </span> </br>
  </div>

</div>

<script src='../js/perlin.js'></script>
<script src='../js/jquery-2.1.3.min.js'></script>
<script src="../js/fileSaver.js"></script>
<script>

var images = [
  ["drum.png",  "Dum Machine Music video", "https://www.youtube.com/watch?v=-5DYDyPvk28"],
  ["p2.jpg", "Alex wong", "https://unsplash.com/photos/l5Tzv1alcps"],
  ["p4.jpg", "vadim kaipov", "https://unsplash.com/photos/WsHdnUs6i28"],
  ["p3.jpg", "Michael Fertig", "https://unsplash.com/photos/KZ1-ncOXdns"],
  ["lemon.jpg", "Hoach Le Dinh", "https://unsplash.com/photos/c8TWWQ5ZnUw"],
  ["p5.jpg", "Sylvain Reygaerts", "https://unsplash.com/photos/kxxL-EhOlBU"],
  ["p6.jpg", "Llywelyn Nys", "https://unsplash.com/photos/pXfewQhyVeU"],
  ["nasa.jpg", "NASA", "https://unsplash.com/photos/rTZW4f02zY8"],
  ["p7.jpg", "Frank Marino", "https://unsplash.com/photos/DiCfM619cRM"],
  ["girl.jpg", "Larisa Birta", "https://unsplash.com/photos/3XARXIgsoqY"],
  ["p8.jpg", "Frank Marino", "https://unsplash.com/photos/7SokKNHZu54"]
];

var index = 0;
var imgsrc = images[index][0];

var Particle = function(){
  this.x = 0;
  this.y = 0;
  this.vy = 0;
  this.age=0;
  
  this.init = function(){
    this.maxLifeTime = Math.floor(5+Math.random()*5);
    this.y = canvas.height * Math.random();
    this.x = Math.random()*canvas.height;
    this.vy = 0.5;
    this.vx = 2;
    this.color= "rgba(0,0,0,0)";
    this.needsColorSet = true;
  }

  this.update = function(value){
    //console.log(value);
    this.age += 0.1;
    this.y -= this.vy;
    this.x += value*this.vx;// + wind;

    if(this.x < 0){
      this.x = canvas.height;
    }else if(this.x > canvas.height){
      this.x = 0;
    }

    if(this.needsColorSet){
      this.needsColorSet = false;
      this.setColor();
    }

    if(this.y < 0){
      //this.y = canvas.height;
      this.init();
    }else if(this.y > canvas.height)
    {
      this.y = 0;
    }

    if(this.age >= this.maxLifeTime){
      this.age = 0;
      this.setColor();
    }
  }

  this.setColor = function(){
   // console.log(this.x, this.y);
    var pixelData = ctx2.getImageData(Math.floor(this.x), Math.floor(this.y), 1, 1).data;
      var r = pixelData[0];
      var g = pixelData[1];
      var b = pixelData[2];
      this.color = "rgba("+r+", "+g+", "+b+",255)";
  }

  this.init();
}

$('#new').click(function(){

  index = ++index%images.length;
  imgsrc = images[index][0];

  doit(imgsrc);
} );

//Obtener dos canvas (Uno va a tener la imagen original y el otro es donde vamos a pintar las particulas)
var canvas = document.getElementById('originalImage');
var ctx = canvas.getContext('2d');
var canvas2 = document.getElementById('particles');
var ctx2 = canvas2.getContext('2d');
var particles = [];
var numParticles = 300;
var delta = 140;
var wind = 0;
var imageReady = false;

canvas.width = canvas2.width = canvas.height = canvas2.height = 500;

function doit(imgsrc){
  
  imageReady = false;
  var img = new Image();   // Create new img element
  img.addEventListener("load", function() {

    ctx.clearRect(0,0, canvas.width, canvas.height);
    ctx2.drawImage(img,0,0);
    imageReady = true;

  }, false);
  
  img.src = imgsrc;

  restart();
  requestAnimationFrame(drawFrame);

};

function drawFrame() {
  
  for(var i=0; i<numParticles; i++){
    var particle = particles[i];
    var value = noise.perlin2(particle.x/delta ,particle.y/delta);
    ctx.fillStyle = particle.color; 
    ctx.fillRect(particle.x,particle.y, 1, 1);
    particle.update(value);
  }

  requestAnimationFrame(drawFrame);
}

function restart(){
  //Give a new seed to the noise function, to get a different pattern
  var seed = Math.random();
  noise.seed(seed);
  self.particles = [];
  delta = 120 + Math.random() * 80;
  for(var i=0; i<numParticles; i++){
    self.particles.push(new Particle());
  }

  $("#delta").html(delta);
  $("#seed").html(seed);
  $("#author").html(images[index][1]);
  $("#author").attr("href",images[index][2]);
  
}

var time = 1000;

function save(){
  
  if(index == 1){
    time += 1000;
  }
  if(time < 10000000){

    if(canvas.toBlob == undefined){
        link.href = canvas.toDataURL();
        link.download = "flowfieldpainting"+time+".png";
      }else{
        canvas.toBlob(function(blob) {
          saveAs(blob, "flowfieldpainting"+time+".png");
        });
      }

    index = ++index%images.length;
    imgsrc = images[index];

    doit(imgsrc);

  }

  t = setTimeout(function(){ save() }, time);
   
}

//save();

 doit(imgsrc);

var num=0;

$('#save').click(function(){
  num++;

if(canvas.toBlob == undefined){
    link.href = canvas.toDataURL();
    link.download = "flowfieldpainting"+num+".png";
  }else{
    canvas.toBlob(function(blob) {
      saveAs(blob, "flowfieldpainting"+num+".png");
    });
  }


})


</script>
</body>